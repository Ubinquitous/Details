## TCP 프로토콜

TCP는 데이터를 확실하게 전달하기 위해 일대일로 통신한다. 이런 통신을 커넥션형 통신이라고 한다.  
다음과 같은 세 단계로 이루어져있다.

1. 수신측이 데이터를 받을 수 있는지 확인하고 통신을 개시한다. ( 통신 연결 )
2. 데이터를 정해진 크기로 분할한 다음, TCP 헤더를 붙여 순서대로 송신한다.
3. 데이터를 다 보내면 통신을 종료한다.

수신측은 받은 데이터를 원래의 형태로 다시 맞춘 후 애플리케이션 계층에 전달하게 된다.

1. TCP 헤더의 정보를 보고 데이터를 순서대로 맞춘다.
2. TCP 헤더를 가지고 데이터를 다시 맞춘다.
3. 애플리케이션 계층의 프로토콜에 전달한다.

## 컨트롤 플래그

통신 상대에게 통신 상태를 전하는 수단으로 사용되는 6비트의 컨트롤 플래그가 있다.  
상대에게 전하고 싶은 항목을 1, 그 이외는 0으로 만들어 통신한다. 각 비트마다 순서대로 의미하는 바가 있다.

| 비트 순서 | 이름 | 의미                                       |
| --------- | ---- | ------------------------------------------ |
| 0         | URG  | 세그먼트가 긴급한 데이터를 가지고 있음     |
| 1         | ACK  | 통신 확인에 대해 알았다고 응답함           |
| 2         | PSH  | 세그먼트를 바로 애플리케이션 계층에 전달함 |
| 3         | RST  | 통신을 강제적으로 해제함                   |
| 4         | SYN  | 통신 개시 요청                             |
| 5         | FIN  | 통신 종료 요청                             |

상대와 서로 확인해가며 주고받는 것을 핸드셰이크라고 한다.  
통신을 개시할 때 TCP에서는 다음과 같은 정보를 주고받는 것을 3-way 핸드셰이크라고 한다.

```
컴퓨터1 : 000010 ( SYN | 통신을 시작합시다 )
컴퓨터2 : 010010 ( ACK, SYN | 알았습니다, 통신을 시작합시다 )
컴퓨터1 : 010000 ( ACK | 알았습니다 )
```

## 데이터 양 확인

통신을 시작하기 전, 양쪽 모두 다룰 수 있는 데이터 양을 확인한다.  
만약 1번 컴퓨터의 세그먼트 사이즈가 150B, 윈도우 사이즈가 32Kb이고,  
2번 컴퓨터의 세그먼트 사이즈가 128B, 윈도우 사이즈가 64Kb이면

세그먼트 사이즈는 128B, 윈도우 사이즈는 32Kb로 통신한다.  
넘쳐 오류가 생기지 않게 수치가 작은 쪽으로 맞춘다.

## 통신 해제

통신을 해제할 때에도 컨트롤 플래그로 연락을 한다.

```
컴퓨터1 : 010001 ( ACK, FIN | 통신을 끝냅시다 )
컴퓨터2 : 010000 ( ACK | 알았습니다 )
컴퓨터2 : 010001 ( ACK, FIN | 통신을 끝냅시다 )
컴퓨터1 : 010000 ( ACK | 알았습니다 )
```

## 시퀀스 번호

TCP 헤더에는 데이터의 순서를 나타내는 시퀀스 번호가 있다.  
헤더를 확실하게 받기 위해 이 번호를 사용해 다음과 같은 주고받기를 한다.

1. 송신측에서 TCP 헤더에 시퀀스 번호를 쓰고, 세그먼트를 보낸다.
2. 수신측에서 시퀀스 번호를 보고, 순서대로 전달되는지를 확인하고, 세그먼트의 다음 번호를 송신측에게 알려준다.
3. 전달되었다는 것을 확인 후 다음 세그먼트를 보낸다.
4. 다음 세그먼트를 받고, 시퀀스 번호를 보고 순서대로 나열한다.

이를 모아서 보낼 수 있다. 세그먼트를 하나씩 보내기보다 몇 개씩 모아서 보내는 것이 효율적이다.  
통신할 때 정해진 윈도우 사이즈까지라면 확인 응답을 기다리지 않고 모아 보낼 수 있다.

윈도우 사이즈는 통신 도중에 변경할 수 있어, 네트워크가 비어있을 때는 크게,  
혼잡할 때는 작게하는 등 상황에 맞게 조절이 가능하다.

## 예외 처리

일정 시간을 기다려도 확인 응답이 없을 때는 송신측은 세그먼트를 재전송한다.  
세그먼트가 지연되거나 분실되어 확인 응답을 보낼 수 없는 경우나,  
확인 응답이 지연되거나 분실되어 예외가 발생하는 경우도 있다.

송신 도중 데이터가 깨지는 경우, 수신측에서는 데이터를 파기하고 확인 응답을 따로 보내지 않는다.  
깨졌는지 여부는 헤더에 있는 체크섬이라는 값을 사용한다.

일정 횟수 이상을 재전송해도 확인 응답이 들어오지 않을 경우, 송신측에서  
컨트롤 플래그를 사용해 강제적으로 통신을 해제한다.
